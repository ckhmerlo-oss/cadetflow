module.exports = [
"[project]/app/favicon.ico.mjs { IMAGE => \"[project]/app/favicon.ico (static in ecmascript, tag client)\" } [app-rsc] (structured image object, ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/app/favicon.ico.mjs { IMAGE => \"[project]/app/favicon.ico (static in ecmascript, tag client)\" } [app-rsc] (structured image object, ecmascript)"));
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[project]/app/layout.tsx [app-rsc] (ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/app/layout.tsx [app-rsc] (ecmascript)"));
}),
"[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (client reference proxy) <module evaluation>", ((__turbopack_context__) => {
"use strict";

// This file is generated by next-core EcmascriptClientReferenceModule.
__turbopack_context__.s([
    "default",
    ()=>__TURBOPACK__default__export__
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call the default export of [project]/app/report/[id]/ReportDetailsClient.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/app/report/[id]/ReportDetailsClient.tsx <module evaluation>", "default");
}),
"[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (client reference proxy)", ((__turbopack_context__) => {
"use strict";

// This file is generated by next-core EcmascriptClientReferenceModule.
__turbopack_context__.s([
    "default",
    ()=>__TURBOPACK__default__export__
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call the default export of [project]/app/report/[id]/ReportDetailsClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/app/report/[id]/ReportDetailsClient.tsx", "default");
}),
"[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (ecmascript)", ((__turbopack_context__) => {
"use strict";

var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$report$2f5b$id$5d2f$ReportDetailsClient$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (client reference proxy) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$report$2f5b$id$5d2f$ReportDetailsClient$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__ = __turbopack_context__.i("[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (client reference proxy)");
;
__turbopack_context__.n(__TURBOPACK__imported__module__$5b$project$5d2f$app$2f$report$2f5b$id$5d2f$ReportDetailsClient$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__);
}),
"[project]/app/report/[id]/page.tsx [app-rsc] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// in app/report/[id]/page.tsx
// NO 'use client' - This is now a Server Component
__turbopack_context__.s([
    "default",
    ()=>ReportDetailsPage
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/utils/supabase/server.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$api$2f$navigation$2e$react$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/next/dist/api/navigation.react-server.js [app-rsc] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$client$2f$components$2f$navigation$2e$react$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/client/components/navigation.react-server.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$report$2f5b$id$5d2f$ReportDetailsClient$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/app/report/[id]/ReportDetailsClient.tsx [app-rsc] (ecmascript)");
;
;
;
;
/**
 * Server-side data fetching function
 */ async function getReportData(reportId, user) {
    const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createClient"])();
    // 1. Fetch main report, logs, and appeal in parallel
    // ... (Data fetching logic remains the same)
    const [reportResult, logResult, appealResult] = await Promise.all([
        supabase.from('demerit_reports').select(`*, subject:subject_cadet_id ( first_name, last_name ), submitter:submitted_by ( first_name, last_name ), offense_type:offense_type_id ( * )`).eq('id', reportId).single(),
        supabase.from('approval_log').select('*, actor:actor_id(first_name, last_name)').eq('report_id', reportId).order('created_at', {
            ascending: false
        }),
        supabase.from('appeals').select('id, status, justification, current_assignee_id, current_group_id, issuer_comment, chain_comment, final_comment').eq('report_id', reportId).maybeSingle()
    ]);
    // --- Error Handling ---
    if (reportResult.error) {
        console.error('Report fetch error:', reportResult.error.message);
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$client$2f$components$2f$navigation$2e$react$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["notFound"])() // Triggers the 404 page
        ;
    }
    const report = reportResult.data;
    const logs = logResult.data || [];
    const appeal = appealResult.data || null;
    // 2. Conditionally fetch data needed for interactions
    // ... (Conditional fetching logic remains the same)
    let offenses = [];
    if (report.submitted_by === user.id && report.status === 'needs_revision') {
        const { data } = await supabase.from('offense_types').select('*').order('offense_group').order('offense_name');
        if (data) offenses = data;
    }
    let escalationTarget = null;
    if (appeal && [
        'rejected_by_issuer',
        'rejected_by_chain'
    ].includes(appeal.status)) {
        const { data } = await supabase.rpc('get_next_escalation_target', {
            p_appeal_id: appeal.id
        });
        if (data) escalationTarget = data;
    }
    // 3. Check all user permissions in parallel
    // Fetch viewer role for Staff check
    const { data: viewerProfile } = await supabase.from('profiles').select('role:role_id (default_role_level)').eq('id', user.id).single();
    const viewerRoleLevel = viewerProfile?.role?.default_role_level || 0;
    // *** UPDATE: Changed threshold from 50 to 90 ***
    // This matches the new SQL policy: only Commandant/Admins (90+) can pull reports they didn't write.
    const isCommandantStaff = viewerRoleLevel >= 90;
    let isApprover = false;
    if (report.current_approver_group_id) {
        const { data: isMember } = await supabase.rpc('is_member_of_approver_group', {
            p_group_id: report.current_approver_group_id
        });
        isApprover = !!isMember;
    }
    let canActOnAppeal = false;
    if (appeal && user) {
        if (appeal.status === 'pending_issuer' && appeal.current_assignee_id === user.id) {
            canActOnAppeal = true;
        } else if ([
            'pending_chain',
            'pending_commandant'
        ].includes(appeal.status) && appeal.current_group_id) {
            const { data: hasPerm } = await supabase.rpc('is_member_of_approver_group', {
                p_group_id: appeal.current_group_id
            });
            if (hasPerm) canActOnAppeal = true;
        }
    }
    // --- Calculate canPull ---
    const isSubmitter = report.submitted_by === user.id;
    const isCompleted = report.status === 'completed';
    const isPending = report.status === 'pending_approval';
    // *** UPDATE: Use isCommandantStaff instead of isStaff ***
    // Allow pulling if (submitter OR Commandant Staff) AND (report is completed OR pending)
    const canPull = (isSubmitter || isCommandantStaff) && (isCompleted || isPending);
    return {
        report,
        logs,
        appeal,
        offenses,
        escalationTarget,
        permissions: {
            isSubmitter: isSubmitter,
            isSubject: report.subject_cadet_id === user.id,
            isApprover,
            canActOnAppeal,
            canPull: !!canPull
        }
    };
}
async function ReportDetailsPage({ params: paramsPromise }) {
    const params = await paramsPromise;
    const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createClient"])();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$client$2f$components$2f$navigation$2e$react$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["redirect"])('/login');
    }
    if (!params.id || params.id === 'undefined' || params.id === 'null') {
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$client$2f$components$2f$navigation$2e$react$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["notFound"])();
    }
    const data = await getReportData(params.id, user);
    // Pass all server-fetched data to the client component
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$app$2f$report$2f5b$id$5d2f$ReportDetailsClient$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["default"], {
        user: user,
        initialReport: data.report,
        initialLogs: data.logs,
        initialAppeal: data.appeal,
        offenses: data.offenses,
        escalationTarget: data.escalationTarget,
        permissions: data.permissions
    }, void 0, false, {
        fileName: "[project]/app/report/[id]/page.tsx",
        lineNumber: 189,
        columnNumber: 5
    }, this);
}
}),
"[project]/app/report/[id]/page.tsx [app-rsc] (ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/app/report/[id]/page.tsx [app-rsc] (ecmascript)"));
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__585cedea._.js.map
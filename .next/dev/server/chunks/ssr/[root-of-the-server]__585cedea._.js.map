{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/report/%5Bid%5D/ReportDetailsClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/app/report/[id]/ReportDetailsClient.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/app/report/[id]/ReportDetailsClient.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAA2S,GACxU,yEACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/report/%5Bid%5D/ReportDetailsClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/app/report/[id]/ReportDetailsClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/app/report/[id]/ReportDetailsClient.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAuR,GACpT,qDACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 54, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/report/%5Bid%5D/page.tsx"],"sourcesContent":["// in app/report/[id]/page.tsx\r\n// NO 'use client' - This is now a Server Component\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { notFound, redirect } from 'next/navigation'\r\nimport ReportDetailsClient from './ReportDetailsClient'\r\nimport { User } from '@supabase/supabase-js'\r\n\r\n// ... (All Type definitions remain the same)\r\ntype Report = {\r\n  id: string;\r\n  status: string;\r\n  notes: string | null;\r\n  submitted_by: string;\r\n  subject_cadet_id: string;\r\n  current_approver_group_id: string | null; \r\n  date_of_offense: string;\r\n  offense_type_id: string;\r\n  demerits_effective: number;\r\n  subject: { first_name: string, last_name: string }; \r\n  submitter: { first_name: string, last_name: string };\r\n  offense_type: {\r\n    offense_name: string;\r\n    offense_code: string;\r\n    demerits: number;\r\n    policy_category: number;\r\n  }\r\n};\r\n\r\ntype Log = {\r\n  id: string;\r\n  action: string;\r\n  comment: string;\r\n  created_at: string;\r\n  actor: { first_name: string, last_name: string } | null; \r\n};\r\n\r\ntype OffenseType = {\r\n  id: string;\r\n  offense_group: string;\r\n  offense_name: string;\r\n  demerits: number;\r\n}\r\n\r\ntype Appeal = {\r\n  id: string;\r\n  status: string;\r\n  justification: string;\r\n  current_assignee_id: string | null;\r\n  current_group_id: string | null;\r\n  issuer_comment: string | null;\r\n  chain_comment: string | null;\r\n  final_comment: string | null;\r\n}\r\n\r\n\r\n/**\r\n * Server-side data fetching function\r\n */\r\nasync function getReportData(reportId: string, user: User) {\r\n  const supabase = createClient()\r\n\r\n  // 1. Fetch main report, logs, and appeal in parallel\r\n  // ... (Data fetching logic remains the same)\r\n  const [reportResult, logResult, appealResult] = await Promise.all([\r\n    supabase\r\n      .from('demerit_reports') \r\n      .select(`*, subject:subject_cadet_id ( first_name, last_name ), submitter:submitted_by ( first_name, last_name ), offense_type:offense_type_id ( * )`)\r\n      .eq('id', reportId)\r\n      .single(),\r\n    supabase\r\n      .from('approval_log')\r\n      .select('*, actor:actor_id(first_name, last_name)')\r\n      .eq('report_id', reportId)\r\n      .order('created_at', { ascending: false }),\r\n    supabase\r\n      .from('appeals')\r\n      .select('id, status, justification, current_assignee_id, current_group_id, issuer_comment, chain_comment, final_comment')\r\n      .eq('report_id', reportId)\r\n      .maybeSingle()\r\n  ])\r\n\r\n  // --- Error Handling ---\r\n  if (reportResult.error) {\r\n    console.error('Report fetch error:', reportResult.error.message)\r\n    return notFound() // Triggers the 404 page\r\n  }\r\n\r\n  const report = reportResult.data as unknown as Report\r\n  const logs = (logResult.data || []) as Log[]\r\n  const appeal = (appealResult.data || null) as Appeal | null\r\n\r\n  // 2. Conditionally fetch data needed for interactions\r\n  // ... (Conditional fetching logic remains the same)\r\n  let offenses: OffenseType[] = []\r\n  if (report.submitted_by === user.id && report.status === 'needs_revision') {\r\n    const { data } = await supabase.from('offense_types').select('*').order('offense_group').order('offense_name')\r\n    if (data) offenses = data as OffenseType[]\r\n  }\r\n\r\n  let escalationTarget: string | null = null\r\n  if (appeal && ['rejected_by_issuer', 'rejected_by_chain'].includes(appeal.status)) {\r\n     const { data } = await supabase.rpc('get_next_escalation_target', { p_appeal_id: appeal.id });\r\n     if (data) escalationTarget = data as string\r\n  }\r\n\r\n  // 3. Check all user permissions in parallel\r\n  \r\n  // Fetch viewer role for Staff check\r\n  const { data: viewerProfile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id (default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const viewerRoleLevel = (viewerProfile?.role as any)?.default_role_level || 0\r\n  \r\n  // *** UPDATE: Changed threshold from 50 to 90 ***\r\n  // This matches the new SQL policy: only Commandant/Admins (90+) can pull reports they didn't write.\r\n  const isCommandantStaff = viewerRoleLevel >= 90\r\n\r\n  let isApprover = false\r\n  if (report.current_approver_group_id) {\r\n    const { data: isMember } = await supabase.rpc('is_member_of_approver_group', {\r\n      p_group_id: report.current_approver_group_id\r\n    })\r\n    isApprover = !!isMember\r\n  }\r\n\r\n  let canActOnAppeal = false\r\n  if (appeal && user) {\r\n      if (appeal.status === 'pending_issuer' && appeal.current_assignee_id === user.id) {\r\n          canActOnAppeal = true;\r\n      } else if (['pending_chain', 'pending_commandant'].includes(appeal.status) && appeal.current_group_id) {\r\n           const { data: hasPerm } = await supabase.rpc('is_member_of_approver_group', { p_group_id: appeal.current_group_id });\r\n           if (hasPerm) canActOnAppeal = true;\r\n      }\r\n  }\r\n\r\n  // --- Calculate canPull ---\r\n  const isSubmitter = report.submitted_by === user.id\r\n  const isCompleted = report.status === 'completed'\r\n  const isPending = report.status === 'pending_approval'\r\n  \r\n  // *** UPDATE: Use isCommandantStaff instead of isStaff ***\r\n  // Allow pulling if (submitter OR Commandant Staff) AND (report is completed OR pending)\r\n  const canPull = (isSubmitter || isCommandantStaff) && (isCompleted || isPending)\r\n\r\n  return {\r\n    report,\r\n    logs,\r\n    appeal,\r\n    offenses,\r\n    escalationTarget,\r\n    permissions: {\r\n      isSubmitter: isSubmitter,\r\n      isSubject: report.subject_cadet_id === user.id,\r\n      isApprover,\r\n      canActOnAppeal,\r\n      canPull: !!canPull, \r\n    }\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * The new Server Component Page\r\n */\r\n// ... (The default export function ReportDetailsPage remains exactly the same)\r\nexport default async function ReportDetailsPage({ params: paramsPromise }: { params: Promise<{ id: string }> }) {\r\n  \r\n  const params = await paramsPromise; \r\n  \r\n  const supabase = createClient()\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) {\r\n    return redirect('/login')\r\n  }\r\n\r\n  if (!params.id || params.id === 'undefined' || params.id === 'null') {\r\n    return notFound()\r\n  }\r\n\r\n  const data = await getReportData(params.id, user)\r\n  \r\n  // Pass all server-fetched data to the client component\r\n  return (\r\n    <ReportDetailsClient\r\n      user={user}\r\n      initialReport={data.report}\r\n      initialLogs={data.logs}\r\n      initialAppeal={data.appeal}\r\n      offenses={data.offenses}\r\n      escalationTarget={data.escalationTarget}\r\n      permissions={data.permissions}\r\n    />\r\n  )\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/action-items/ActionItemsClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/app/action-items/ActionItemsClient.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/app/action-items/ActionItemsClient.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAA0S,GACvU,wEACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/action-items/ActionItemsClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/app/action-items/ActionItemsClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/app/action-items/ActionItemsClient.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAsR,GACnT,oDACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 54, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/action-items/page.tsx"],"sourcesContent":["import { createClient } from '@/utils/supabase/server'\r\nimport { redirect } from 'next/navigation'\r\nimport ActionItemsClient from './ActionItemsClient'\r\n\r\nexport type ActionItemReport = {\r\n  id: string;\r\n  status: string;\r\n  created_at: string;\r\n  current_approver_group_id: string | null;\r\n  subject_cadet_id: string;\r\n  submitted_by: string;\r\n  subject: { first_name: string, last_name: string };\r\n  submitter: { first_name: string, last_name: string };\r\n  group: { group_name: string } | null;\r\n  offense_type: { offense_name: string; demerits: number };\r\n  notes: string | null;\r\n  \r\n  // --- Appeal Specific Data ---\r\n  appeal_status: string | null;\r\n  appeal_id: string | null;\r\n  appeal_justification: string | null;\r\n  appeal_issuer_comment: string | null;\r\n  appeal_chain_comment: string | null;\r\n  // ----------------------------\r\n  \r\n  logs: {\r\n    actor_name: string;\r\n    action: string;\r\n    created_at: string;\r\n    comment: string;\r\n  }[];\r\n}\r\n\r\nexport default async function ActionItemsPage() {\r\n  const supabase = createClient()\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return redirect('/login')\r\n\r\n  // 1. Fetch All Involved Reports\r\n  const { data: rpcData, error } = await supabase.rpc('get_my_dashboard_reports')\r\n  \r\n  if (error) {\r\n    console.error(\"Error fetching reports:\", error.message)\r\n    return <div className=\"p-8 text-red-600\">Error loading action items.</div>\r\n  }\r\n\r\n  let allInvolvedReports = (rpcData || []) as any[]\r\n\r\n  // 2. Fetch Appeals for ALL involved reports (to ensure we don't miss status if RPC doesn't return it)\r\n  const allReportIds = allInvolvedReports.map(r => r.id);\r\n  let appealsMap: Record<string, any> = {};\r\n  \r\n  if (allReportIds.length > 0) {\r\n      const { data: appealsData } = await supabase\r\n        .from('appeals')\r\n        .select('id, report_id, status, justification, issuer_comment, chain_comment')\r\n        .in('report_id', allReportIds);\r\n        \r\n      if (appealsData) {\r\n          appealsData.forEach(app => {\r\n              appealsMap[app.report_id] = app;\r\n          });\r\n      }\r\n  }\r\n\r\n  // 3. Filter for Action Items\r\n  let filteredReports = allInvolvedReports.filter(report => {\r\n      if (report.status === 'pulled') return false;\r\n      \r\n      // Pending Approval (Standard)\r\n      if (report.status === 'pending_approval' && report.current_approver_group_id !== null) return true;\r\n      \r\n      // Needs Revision\r\n      if (report.status === 'needs_revision' && report.submitted_by === user.id) return true;\r\n      \r\n      // Appeal Actions\r\n      // Check RPC status OR the fetched map status\r\n      const appealStatus = report.appeal_status || appealsMap[report.id]?.status;\r\n      \r\n      if (appealStatus) {\r\n          // If I am the subject, I act if it was rejected (to escalate)\r\n          if (report.subject_cadet_id === user.id) return ['rejected_by_issuer', 'rejected_by_chain'].includes(appealStatus);\r\n          // If I am authority, I act if it is pending\r\n          return ['pending_issuer', 'pending_chain', 'pending_commandant'].includes(appealStatus);\r\n      }\r\n      return false;\r\n  });\r\n\r\n  const filteredIds = filteredReports.map(r => r.id);\r\n  \r\n  // 4. Fetch Logs for filtered items\r\n  let logsMap: Record<string, any[]> = {};\r\n  if (filteredIds.length > 0) {\r\n    const { data: logsData } = await supabase\r\n        .from('approval_log')\r\n        .select('report_id, action, comment, created_at, actor:actor_id(first_name, last_name)')\r\n        .in('report_id', filteredIds)\r\n        .order('created_at', { ascending: false });\r\n        \r\n    if (logsData) {\r\n        logsData.forEach(log => {\r\n            if (!logsMap[log.report_id]) logsMap[log.report_id] = [];\r\n            const actor = Array.isArray(log.actor) ? log.actor[0] : log.actor;\r\n            logsMap[log.report_id].push({\r\n                actor_name: actor ? `${actor.last_name}, ${actor.first_name}` : 'Unknown',\r\n                action: log.action,\r\n                created_at: log.created_at,\r\n                comment: log.comment\r\n            });\r\n        });\r\n    }\r\n  }\r\n\r\n  // 5. Map to Final Type\r\n  const actionItems: ActionItemReport[] = filteredReports.map(item => {\r\n        // Normalize array/object responses from Supabase joins\r\n        const subjectObj = Array.isArray(item.subject) ? item.subject[0] : item.subject;\r\n        const submitterObj = Array.isArray(item.submitter) ? item.submitter[0] : item.submitter;\r\n        const groupObj = Array.isArray(item.group) ? item.group[0] : item.group;\r\n        const offenseObj = Array.isArray(item.offense_type) ? item.offense_type[0] : item.offense_type;\r\n        \r\n        const appealData = appealsMap[item.id] || {};\r\n\r\n        return {\r\n            id: item.id,\r\n            status: item.status,\r\n            created_at: item.created_at,\r\n            current_approver_group_id: item.current_approver_group_id,\r\n            subject_cadet_id: item.subject_cadet_id,\r\n            submitted_by: item.submitted_by,\r\n            \r\n            subject: subjectObj || { first_name: 'Unknown', last_name: 'Unknown' },\r\n            submitter: submitterObj || { first_name: 'Unknown', last_name: 'Unknown' },\r\n            group: groupObj,\r\n            \r\n            offense_type: { \r\n                offense_name: offenseObj?.offense_name || item.title || 'Unknown Offense',\r\n                demerits: 0 \r\n            },\r\n            notes: item.notes,\r\n            \r\n            // --- Populate Appeal Fields (Fixes 2322 Error) ---\r\n            appeal_status: item.appeal_status || appealData.status || null,\r\n            appeal_id: appealData.id || null,\r\n            appeal_justification: appealData.justification || null,\r\n            appeal_issuer_comment: appealData.issuer_comment || null,\r\n            appeal_chain_comment: appealData.chain_comment || null,\r\n            // -------------------------------------------------\r\n            \r\n            logs: logsMap[item.id] || []\r\n        };\r\n  })\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto p-4 sm:p-6 lg:p-8\">\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Action Items</h1>\r\n          <p className=\"mt-1 text-sm text-gray-500 dark:text-gray-400\">\r\n            Reports requiring your immediate attention. Select rows to perform bulk actions.\r\n          </p>\r\n        </div>\r\n      </div>\r\n      \r\n      <ActionItemsClient initialReports={actionItems} currentUserId={user.id} />\r\n    </div>\r\n  )\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}
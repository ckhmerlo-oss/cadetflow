{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/admin/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient as createServerClient } from '@/utils/supabase/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\nimport { revalidatePath } from 'next/cache'\r\n\r\n// --- EXISTING: Password Reset ---\r\nexport async function adminResetPassword(prevState: any, formData: FormData) {\r\n  const userId = formData.get('userId') as string\r\n  const newPassword = formData.get('newPassword') as string\r\n\r\n  if (!userId || !newPassword) {\r\n    return { error: 'User ID and New Password are required.', success: false }\r\n  }\r\n\r\n  if (newPassword.length < 6) {\r\n    return { error: 'Password must be at least 6 characters.', success: false }\r\n  }\r\n\r\n  try {\r\n    const supabase = createServerClient()\r\n    const { data: { user }, } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Not authenticated')\r\n\r\n    // Standard permission check\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('profiles')\r\n      .select('role:role_id(default_role_level)')\r\n      .eq('id', user.id)\r\n      .single()\r\n\r\n    if (profileError) throw new Error('Could not verify user profile.')\r\n    \r\n    const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n    if (roleLevel < 90) throw new Error('Permission denied: Admin rights required.')\r\n    \r\n    // Create Admin Client for Auth operations\r\n    const supabaseAdmin = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n    )\r\n\r\n    const { error } = await supabaseAdmin.auth.admin.updateUserById(userId, {\r\n      password: newPassword,\r\n    })\r\n\r\n    if (error) throw error\r\n\r\n    return { error: null, success: true }\r\n  } catch (error: any) {\r\n    return { error: `Failed to reset: ${error.message}`, success: false }\r\n  }\r\n}\r\n\r\n// --- NEW: Company Management ---\r\n\r\nexport async function createCompanyAction(formData: FormData) {\r\n  const supabase = createServerClient()\r\n  const name = formData.get('name') as string\r\n\r\n  if (!name.trim()) return { error: \"Company Name is required\" }\r\n\r\n  // 1. Auth & Permission Check\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: \"Unauthorized\" }\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) return { error: \"Permission Denied\" }\r\n\r\n  // 2. Insert\r\n  const { error } = await supabase\r\n    .from('companies')\r\n    .insert({ company_name: name.trim() })\r\n\r\n  if (error) return { error: error.message }\r\n  \r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteCompanyAction(companyId: string) {\r\n  const supabase = createServerClient()\r\n\r\n  // 1. Auth & Permission Check\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: \"Unauthorized\" }\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) return { error: \"Permission Denied\" }\r\n\r\n  // 2. Delete\r\n  const { error } = await supabase\r\n    .from('companies')\r\n    .delete()\r\n    .eq('id', companyId)\r\n\r\n  if (error) {\r\n      // Handle FK constraints nicely\r\n      if (error.code === '23503') {\r\n          return { error: \"Cannot delete: This company has cadets or staff assigned to it.\" }\r\n      }\r\n      return { error: error.message }\r\n  }\r\n  \r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\n// --- UPDATED: Role Management Actions ---\r\n\r\nexport async function createAdminRoleAction(formData: FormData) {\r\n  const supabase = createServerClient()\r\n  \r\n  const roleName = formData.get('roleName') as string\r\n  const defaultLevel = parseInt(formData.get('defaultLevel') as string) || 0\r\n  const companyId = formData.get('companyId') as string || null\r\n  const approvalGroupId = formData.get('approvalGroupId') as string || null // <--- NEW\r\n  const canManageOwn = formData.get('canManageOwn') === 'on'\r\n  const canManageAll = formData.get('canManageAll') === 'on'\r\n\r\n  if (!roleName.trim()) return { error: \"Role Name is required\" }\r\n\r\n  // 1. Auth Check\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: \"Unauthorized\" }\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) return { error: \"Permission Denied\" }\r\n\r\n  // 2. Insert\r\n  const { error } = await supabase\r\n    .from('roles')\r\n    .insert({\r\n      role_name: roleName.trim(),\r\n      default_role_level: defaultLevel,\r\n      company_id: companyId,\r\n      approval_group_id: approvalGroupId, // <--- SAVING\r\n      can_manage_own_company_roster: canManageOwn,\r\n      can_manage_all_rosters: canManageAll\r\n    })\r\n\r\n  if (error) return { error: error.message }\r\n  \r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\nexport async function updateAdminRoleAction(formData: FormData) {\r\n  const supabase = createServerClient()\r\n  \r\n  const roleId = formData.get('roleId') as string\r\n  const roleName = formData.get('roleName') as string\r\n  const defaultLevel = parseInt(formData.get('defaultLevel') as string) || 0\r\n  const companyId = formData.get('companyId') as string || null\r\n  const approvalGroupId = formData.get('approvalGroupId') as string || null // <--- NEW\r\n  const canManageOwn = formData.get('canManageOwn') === 'on'\r\n  const canManageAll = formData.get('canManageAll') === 'on'\r\n\r\n  if (!roleId) return { error: \"Role ID is required\" }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: \"Unauthorized\" }\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) return { error: \"Permission Denied\" }\r\n\r\n  const { error } = await supabase\r\n    .from('roles')\r\n    .update({\r\n      role_name: roleName.trim(),\r\n      default_role_level: defaultLevel,\r\n      company_id: companyId,\r\n      approval_group_id: approvalGroupId, // <--- SAVING\r\n      can_manage_own_company_roster: canManageOwn,\r\n      can_manage_all_rosters: canManageAll\r\n    })\r\n    .eq('id', roleId)\r\n\r\n  if (error) return { error: error.message }\r\n  \r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteAdminRoleAction(roleId: string) {\r\n  const supabase = createServerClient()\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: \"Unauthorized\" }\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n  \r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) return { error: \"Permission Denied\" }\r\n\r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} users are currently assigned to this role.` }\r\n  }\r\n\r\n  const { error } = await supabase\r\n    .from('roles')\r\n    .delete()\r\n    .eq('id', roleId)\r\n\r\n  if (error) return { error: error.message }\r\n  \r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 251, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/.next-internal/server/app/admin/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {adminResetPassword as '608e5914a99cd89e1d3e43764c86a13361e1288d2c'} from 'ACTIONS_MODULE0'\nexport {createAdminRoleAction as '409cbb727408449410bfea660db2abfb11797904d6'} from 'ACTIONS_MODULE0'\nexport {updateAdminRoleAction as '400bac5072b2551d4bd28c32bf2e33039b2da0bb73'} from 'ACTIONS_MODULE0'\nexport {deleteAdminRoleAction as '40dcef34cc16fdbc2c174e912844adf0f3f625342d'} from 'ACTIONS_MODULE0'\nexport {createCompanyAction as '401f2a511d0b58b3c3417f75c84cb385686a805049'} from 'ACTIONS_MODULE0'\nexport {deleteCompanyAction as '40f9e26d10a4fa3408cc94a726980f8ab3047bd1fe'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\n\r\n// --- HELPER ---\r\nasync function getActorWithPermissions(supabase: any) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return null\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select(`\r\n      id, \r\n      company_id, \r\n      role:role_id (\r\n        role_name, \r\n        default_role_level, \r\n        can_manage_all_rosters, \r\n        can_manage_own_company_roster\r\n      )\r\n    `)\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  if (!profile || !profile.role) return null\r\n\r\n  const role = profile.role as any\r\n  return {\r\n    userId: profile.id,\r\n    companyId: profile.company_id,\r\n    roleLevel: role.default_role_level || 0,\r\n    canManageAll: role.can_manage_all_rosters || false,\r\n    canManageOwn: role.can_manage_own_company_roster || false,\r\n    roleName: role.role_name\r\n  }\r\n}\r\n\r\n// --- ACTIONS ---\r\n\r\nexport async function updateUserRole(userId: string, roleId: string | null) {\r\n  // If clearing a role (null), we treat it as assigning roleId \"\" or similar\r\n  // But bulkAssignRole expects a string.\r\n  // If roleId is null, we are essentially unassigning.\r\n  // Let's handle null separately or ensure bulkAssignRole handles it.\r\n  if (!roleId) {\r\n      // Unassign logic could be separate, or we pass a special flag?\r\n      // For now, let's assume roleId is required for assignment.\r\n      // To unassign, we might need a separate action or allow null.\r\n      // Let's keep it simple: This action is for ASSIGNING.\r\n      return { error: \"Role ID is required.\" }\r\n  }\r\n  return bulkAssignRole([userId], roleId)\r\n}\r\n\r\nexport async function bulkAssignRole(userIds: string[], roleId: string) {\r\n  const supabase = createClient()\r\n  const actor = await getActorWithPermissions(supabase)\r\n  \r\n  if (!actor) return { error: \"Unauthorized\" }\r\n\r\n  // 1. FETCH TARGET ROLE DETAILS\r\n  const { data: targetRole } = await supabase\r\n    .from('roles')\r\n    .select('default_role_level, company_id')\r\n    .eq('id', roleId)\r\n    .single()\r\n    \r\n  if (!targetRole) return { error: \"Role not found.\" }\r\n\r\n  const targetRoleLevel = targetRole.default_role_level || 0\r\n  \r\n  // 2. HIERARCHY CHECK\r\n  // You cannot assign a role that is equal to or higher than your own.\r\n  if (targetRoleLevel >= actor.roleLevel) {\r\n    return { error: `Permission Denied: You cannot assign a role of level ${targetRoleLevel} (your level is ${actor.roleLevel}).` }\r\n  }\r\n\r\n  // 3. SCOPE CHECK\r\n  if (actor.canManageAll) {\r\n    // Allowed globally\r\n  } else if (actor.canManageOwn) {\r\n    // a) Role must belong to the actor's company (or be generic/global if that's allowed, but usually specific)\r\n    // Strict mode: Role must be in actor's company\r\n    if (targetRole.company_id && targetRole.company_id !== actor.companyId) {\r\n        return { error: \"Permission Denied: You cannot assign roles from another company.\" }\r\n    }\r\n\r\n    // b) Target Users must be in actor's company OR unassigned\r\n    const { data: targets } = await supabase\r\n      .from('profiles')\r\n      .select('id, company_id')\r\n      .in('id', userIds)\r\n\r\n    if (!targets) return { error: \"Could not verify targets.\" }\r\n\r\n    const allValid = targets.every(t => t.company_id === actor.companyId || t.company_id === null)\r\n    \r\n    if (!allValid) {\r\n      return { error: \"Permission Denied: You can only manage cadets within your own company or claim unassigned cadets.\" }\r\n    }\r\n  } else {\r\n    return { error: \"Unauthorized: You do not have roster management permissions.\" }\r\n  }\r\n\r\n  // 4. EXECUTE\r\n  // We use the standard client because we assume the RLS policy (from 5_roster_permissions_and_rls.sql) \r\n  // correctly allows updates if (can_manage_own AND (target.company = my_company OR target.company IS NULL))\r\n  \r\n  const { error } = await supabase\r\n    .from('profiles')\r\n    .update({ role_id: roleId })\r\n    .in('id', userIds)\r\n\r\n  if (error) return { error: `Database Error: ${error.message}` }\r\n\r\n  revalidatePath('/manage')\r\n  revalidatePath('/roster')\r\n  return { success: true }\r\n}\r\n\r\nexport async function bulkAssignCompany(userIds: string[], companyId: string) {\r\n  const supabase = createClient()\r\n  const actor = await getActorWithPermissions(supabase)\r\n  \r\n  if (!actor) return { error: \"Unauthorized\" }\r\n\r\n  // 1. SCOPE CHECK\r\n  if (actor.canManageAll) {\r\n     // Global allowed\r\n  } else if (actor.canManageOwn) {\r\n     // Can only move TO own company\r\n     if (companyId !== actor.companyId) {\r\n        return { error: \"Permission Denied: You can only assign cadets to your own company.\" }\r\n     }\r\n\r\n     // Verify targets are Unassigned or in Own Company\r\n     const { data: targets } = await supabase\r\n       .from('profiles')\r\n       .select('company_id')\r\n       .in('id', userIds)\r\n\r\n     if (!targets) return { error: \"Could not verify targets.\" }\r\n\r\n     const allValid = targets.every(t => t.company_id === actor.companyId || t.company_id === null)\r\n     if (!allValid) {\r\n         return { error: \"Permission Denied: You can only claim unassigned cadets or move cadets already in your company.\" }\r\n     }\r\n  } else {\r\n     return { error: \"Unauthorized.\" }\r\n  }\r\n\r\n  // 2. EXECUTE\r\n  const { error } = await supabase\r\n    .from('profiles')\r\n    .update({ company_id: companyId })\r\n    .in('id', userIds)\r\n\r\n  if (error) return { error: error.message }\r\n\r\n  revalidatePath('/manage')\r\n  revalidatePath('/roster')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;;;AAEA;AACA;;;;;AAEA,iBAAiB;AACjB,eAAe,wBAAwB,QAAa;IAClD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;IAElB,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,CAAC;;;;;;;;;IAST,CAAC,EACA,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,EAAE,OAAO;IAEtC,MAAM,OAAO,QAAQ,IAAI;IACzB,OAAO;QACL,QAAQ,QAAQ,EAAE;QAClB,WAAW,QAAQ,UAAU;QAC7B,WAAW,KAAK,kBAAkB,IAAI;QACtC,cAAc,KAAK,sBAAsB,IAAI;QAC7C,cAAc,KAAK,6BAA6B,IAAI;QACpD,UAAU,KAAK,SAAS;IAC1B;AACF;AAIO,eAAe,eAAe,MAAc,EAAE,MAAqB;IACxE,2EAA2E;IAC3E,uCAAuC;IACvC,qDAAqD;IACrD,oEAAoE;IACpE,IAAI,CAAC,QAAQ;QACT,+DAA+D;QAC/D,2DAA2D;QAC3D,8DAA8D;QAC9D,sDAAsD;QACtD,OAAO;YAAE,OAAO;QAAuB;IAC3C;IACA,OAAO,eAAe;QAAC;KAAO,EAAE;AAClC;AAEO,eAAe,eAAe,OAAiB,EAAE,MAAc;IACpE,MAAM,WAAW,IAAA,2IAAY;IAC7B,MAAM,QAAQ,MAAM,wBAAwB;IAE5C,IAAI,CAAC,OAAO,OAAO;QAAE,OAAO;IAAe;IAE3C,+BAA+B;IAC/B,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,SACL,MAAM,CAAC,kCACP,EAAE,CAAC,MAAM,QACT,MAAM;IAET,IAAI,CAAC,YAAY,OAAO;QAAE,OAAO;IAAkB;IAEnD,MAAM,kBAAkB,WAAW,kBAAkB,IAAI;IAEzD,qBAAqB;IACrB,qEAAqE;IACrE,IAAI,mBAAmB,MAAM,SAAS,EAAE;QACtC,OAAO;YAAE,OAAO,CAAC,qDAAqD,EAAE,gBAAgB,gBAAgB,EAAE,MAAM,SAAS,CAAC,EAAE,CAAC;QAAC;IAChI;IAEA,iBAAiB;IACjB,IAAI,MAAM,YAAY,EAAE;IACtB,mBAAmB;IACrB,OAAO,IAAI,MAAM,YAAY,EAAE;QAC7B,4GAA4G;QAC5G,+CAA+C;QAC/C,IAAI,WAAW,UAAU,IAAI,WAAW,UAAU,KAAK,MAAM,SAAS,EAAE;YACpE,OAAO;gBAAE,OAAO;YAAmE;QACvF;QAEA,2DAA2D;QAC3D,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,kBACP,EAAE,CAAC,MAAM;QAEZ,IAAI,CAAC,SAAS,OAAO;YAAE,OAAO;QAA4B;QAE1D,MAAM,WAAW,QAAQ,KAAK,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,MAAM,SAAS,IAAI,EAAE,UAAU,KAAK;QAEzF,IAAI,CAAC,UAAU;YACb,OAAO;gBAAE,OAAO;YAAoG;QACtH;IACF,OAAO;QACL,OAAO;YAAE,OAAO;QAA+D;IACjF;IAEA,aAAa;IACb,uGAAuG;IACvG,2GAA2G;IAE3G,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,YACL,MAAM,CAAC;QAAE,SAAS;IAAO,GACzB,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO,OAAO;QAAE,OAAO,CAAC,gBAAgB,EAAE,MAAM,OAAO,EAAE;IAAC;IAE9D,IAAA,+IAAc,EAAC;IACf,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;IAAK;AACzB;AAEO,eAAe,kBAAkB,OAAiB,EAAE,SAAiB;IAC1E,MAAM,WAAW,IAAA,2IAAY;IAC7B,MAAM,QAAQ,MAAM,wBAAwB;IAE5C,IAAI,CAAC,OAAO,OAAO;QAAE,OAAO;IAAe;IAE3C,iBAAiB;IACjB,IAAI,MAAM,YAAY,EAAE;IACrB,iBAAiB;IACpB,OAAO,IAAI,MAAM,YAAY,EAAE;QAC5B,+BAA+B;QAC/B,IAAI,cAAc,MAAM,SAAS,EAAE;YAChC,OAAO;gBAAE,OAAO;YAAqE;QACxF;QAEA,kDAAkD;QAClD,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,cACP,EAAE,CAAC,MAAM;QAEZ,IAAI,CAAC,SAAS,OAAO;YAAE,OAAO;QAA4B;QAE1D,MAAM,WAAW,QAAQ,KAAK,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,MAAM,SAAS,IAAI,EAAE,UAAU,KAAK;QACzF,IAAI,CAAC,UAAU;YACX,OAAO;gBAAE,OAAO;YAAkG;QACtH;IACH,OAAO;QACJ,OAAO;YAAE,OAAO;QAAgB;IACnC;IAEA,aAAa;IACb,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,YACL,MAAM,CAAC;QAAE,YAAY;IAAU,GAC/B,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO,OAAO;QAAE,OAAO,MAAM,OAAO;IAAC;IAEzC,IAAA,+IAAc,EAAC;IACf,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;IAAK;AACzB;;;IA3HsB;IAeA;IAkEA;;AAjFA,+OAAA;AAeA,+OAAA;AAkEA,+OAAA","debugId":null}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/.next-internal/server/app/manage/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {bulkAssignCompany as '603a47877742303afc33baf0bf80c9229af4e52ef8'} from 'ACTIONS_MODULE0'\nexport {bulkAssignRole as '60532683f7b9907727bf29a27c70ffe98877d06a86'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}
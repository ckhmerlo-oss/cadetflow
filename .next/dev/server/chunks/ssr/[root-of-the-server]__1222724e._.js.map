{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/page.tsx"],"sourcesContent":["// in app/page.tsx\nimport { createClient } from '@/utils/supabase/server'\nimport Link from 'next/link'\nimport { redirect } from 'next/navigation'\n\n// --- Types ---\ntype ReportWithNames = {\n  id: string;\n  status: string;\n  created_at: string;\n  current_approver_group_id: string | null;\n  subject_cadet_id: string;\n  submitted_by: string;\n  subject: { first_name: string, last_name: string } | null;\n  submitter: { first_name: string, last_name: string } | null;\n  group: { group_name: string } | null;\n  offense_type: { offense_name: string } | null;\n  appeal_status: string | null;\n}\n\ntype CadetStats = {\n  term_demerits: number;\n  year_demerits: number;\n  total_tours_marched: number;\n  current_tour_balance: number;\n}\n\nexport default async function Dashboard() {\n  const supabase = createClient()\n\n  // 1. Get User & Profile\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) return redirect('/login')\n\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select(`first_name, last_name, company_id, role:role_id (default_role_level, can_manage_all_rosters, approval_group:approval_group_id (group_name))`)\n    .eq('id', user.id)\n    .single()\n\n  if (profile && profile.company_id === null && profile.first_name === 'New') return redirect('/onboarding')\n\n  const role = profile?.role as any\n  const role_level = role?.default_role_level || 0\n\n  if (role_level === 10) {\n    redirect(`/ledger/${user.id}`);\n  }\n  \n  const canManageAll = role?.can_manage_all_rosters || false\n  const isFaculty = role_level >= 50 || canManageAll\n  const groupName = role?.approval_group?.group_name || 'Personal Dashboard'\n\n  // 2. Fetch Data\n  const { data: rpcData, error } = await supabase.rpc('get_my_dashboard_reports')\n  const allInvolvedReports: ReportWithNames[] = rpcData || [];\n  if (error) console.error(\"Error fetching reports:\", error.message)\n\n  let allPendingReports: ReportWithNames[] = [];\n  let cadetStats: CadetStats | null = null; \n  let allCompletedReports: ReportWithNames[] = []; \n\n  if (isFaculty) {\n    const { data: facultyData } = await supabase.rpc('get_all_pending_reports_for_faculty')\n    allPendingReports = facultyData?.map((item: any) => ({ ...item, subject: item.subject, submitter: item.submitter, group: item.group, offense_type: { offense_name: item.title } })) as ReportWithNames[] || [];\n\n    const { data: completedData } = await supabase.rpc('get_all_completed_reports_for_faculty')\n    allCompletedReports = completedData?.map((item: any) => ({ \n        ...item, \n        subject: item.subject, \n        submitter: item.submitter, \n        group: item.group, \n        offense_type: { offense_name: item.title },\n        appeal_status: item.appeal_status \n    })) as ReportWithNames[] || [];\n  } else {\n    const { data: statsData } = await supabase.rpc('get_cadet_ledger_stats', { p_cadet_id: user.id }).single<CadetStats>()\n    if (statsData) cadetStats = statsData;\n  }\n    \n  // 3. Filter Lists\n  const actionItems = allInvolvedReports.filter(report => {\n      if (report.status === 'pending_approval' && report.current_approver_group_id !== null) return true;\n      if (report.status === 'needs_revision' && report.submitted_by === user.id) return true;\n      if (report.appeal_status) {\n          if (report.subject_cadet_id === user.id) return ['rejected_by_issuer', 'rejected_by_chain'].includes(report.appeal_status);\n          return ['pending_issuer', 'pending_chain', 'pending_commandant'].includes(report.appeal_status);\n      }\n      return false;\n  }) || []\n\n  const mySubmittedReports = allInvolvedReports.filter(report => report.submitted_by === user.id) || []\n\n  return (\n    <div className=\"max-w-7xl mx-auto p-4 sm:p-6 lg:p-8\">\n      <div className=\"flex justify-between items-center mb-8\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Welcome, {profile?.first_name || user.email}</h1>\n          <p className=\"mt-2 text-lg text-gray-600 dark:text-gray-400\">{groupName}</p>\n        </div>\n        <div>\n          {(role_level >= 15) && (\n            <Link href=\"/submit\" className=\"py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors\">\n              Submit New Report\n            </Link>\n          )}\n        </div>\n      </div>\n\n      {!isFaculty && cadetStats && (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div className=\"md:col-span-2\"><div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\"><CadetStatsHeader stats={cadetStats} /></div></div>\n          <div className=\"bg-sky-300 dark:bg-indigo-900 rounded-lg shadow-sm flex overflow-hidden\">\n            <Link href={`/ledger/${user.id}`} className=\"flex-1 flex items-center justify-center p-6 text-lg font-bold text-white hover:bg-sky-500 dark:hover:bg-indigo-600 transition-colors w-full h-full text-center\">All Reports</Link>\n          </div>\n        </div>\n      )}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6\">\n        {(role_level >= 15) && <DashboardSection title=\"Action Items\" items={actionItems} emptyMessage=\"No action items in your queue. Great job!\" showSubject />}\n        {isFaculty && canManageAll && <DashboardSection title=\"All In-Progress Reports\" items={allPendingReports} emptyMessage=\"No reports pending approval.\" showSubject />}\n        {(role_level >= 15) && <DashboardSection title=\"Submitted Reports\" items={mySubmittedReports} emptyMessage=\"You haven't submitted any reports yet.\" showSubject />}\n        {isFaculty && <DashboardSection title=\"Completed Archive\" items={allCompletedReports} emptyMessage=\"No completed reports found.\" showSubject />}\n      </div>\n    </div>\n  )\n}\n\n// --- Helper Components ---\nfunction CadetStatsHeader({ stats }: { stats: CadetStats }) {\n  return (\n    <>\n      <StatCard title=\"Current Term Demerits\" value={stats.term_demerits} />\n      <StatCard title=\"Academic Year Demerits\" value={stats.year_demerits} />\n      <StatCard title=\"Current Tour Balance\" value={stats.current_tour_balance} />\n    </>\n  )\n}\n\nfunction StatCard({ title, value }: { title: string, value: string | number }) {\n  return (\n    <div className=\"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm\">\n      <h3 className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">{title}</h3>\n      <p className=\"text-3xl font-bold mt-2 text-gray-900 dark:text-white\">{value}</p>\n    </div>\n  )\n}\n\nfunction DashboardSection({ title, items, emptyMessage, showSubject = false, showSubmitter = false }: { title: string; items: ReportWithNames[]; emptyMessage: string; showSubject?: boolean; showSubmitter?: boolean; }) {\n  return (\n    <div className=\"space-y-4\">\n      <h2 className=\"text-2xl font-semibold text-gray-800 dark:text-gray-100\">{title} ({items?.length || 0})</h2>\n      <div className=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm space-y-3 h-96 overflow-y-auto\">\n        {items && items.length > 0 ? items.map(report => <ReportCard key={report.id} report={report} showSubject={showSubject} showSubmitter={showSubmitter} />) : <p className=\"text-gray-500 dark:text-gray-400 p-4\">{emptyMessage}</p>}\n      </div>\n    </div>\n  )\n}\n\nfunction ReportCard({ report, showSubject, showSubmitter }: { report: ReportWithNames; showSubject?: boolean; showSubmitter?: boolean }) {\n  \n  const getStatusColor = () => {\n    switch (report.status) {\n      case 'completed': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100'\n      case 'rejected': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100'\n      case 'pending_approval': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100'\n      case 'needs_revision': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100'\n      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100'\n    }\n  }\n\n  const formatName = (person: { first_name: string, last_name: string } | null) => person ? `${person.last_name}, ${person.first_name.charAt(0)}.` : 'N/A';\n  const formatStatus = (status: string) => status.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n  const title = report.offense_type?.offense_name || 'Untitled Report';\n\n  // *** NEW HELPER: Get color-coded appeal badge ***\n  const getAppealBadge = (status: string) => {\n      if (status === 'approved') {\n          return <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">Appeal Granted</span>\n      } else if (status === 'rejected_final') {\n          return <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\">Appeal Denied</span>\n      } else {\n           // Pending or intermediate rejected states\n           return <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\">Appeal In Progress</span>\n      }\n  }\n\n  return (\n    <Link \n      href={`/report/${report.id}`} \n      // *** REVERTED: Removed 'appealStyle' custom background/border ***\n      className=\"block p-4 border border-gray-200 dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors\"\n    >\n      <div className=\"flex justify-between items-center\">\n        <div className=\"truncate flex items-center\">\n             <span className=\"font-medium text-indigo-600 dark:text-indigo-400 truncate mr-2\">{title}</span>\n             {/* *** UPDATED: Use new badge helper *** */}\n             {report.appeal_status && getAppealBadge(report.appeal_status)}\n        </div>\n        <span className={`text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${getStatusColor()}`}>\n          {formatStatus(report.status)}\n        </span>\n      </div>\n      <div className=\"mt-2 text-sm text-gray-500 dark:text-gray-400\">\n        {showSubject && <p>Subject: <span className=\"font-medium text-gray-700 dark:text-gray-200\">{formatName(report.subject)}</span></p>}\n        {showSubmitter && <p>Submitter: <span className=\"font-medium text-gray-700 dark:text-gray-200\">{formatName(report.submitter)}</span></p>}\n        {report.status === 'pending_approval' && <p>Waiting for: <span className=\"font-medium text-gray-700 dark:text-gray-200\">{report.group?.group_name || 'N/A'}</span></p>}\n      </div>\n    </Link>\n  )\n}"],"names":[],"mappings":"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","debugId":null}}]
}
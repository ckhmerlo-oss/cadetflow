{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IAoCsB,kBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IAoLsB,oBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/components/GroupNode.tsx"],"sourcesContent":["// app/manage/roles/components/GroupNode.tsx\r\nimport { ApprovalGroupNode } from '../actions'\r\nimport React from 'react'\r\n\r\ninterface GroupNodeProps {\r\n  node: ApprovalGroupNode\r\n  onDelete: (e: React.MouseEvent) => void\r\n  onAddParent: (e: React.MouseEvent) => void\r\n  onAddSubordinate: (e: React.MouseEvent) => void // <--- NEW\r\n}\r\n\r\nexport default function GroupNode({ node, onDelete, onAddParent, onAddSubordinate }: GroupNodeProps) {\r\n  \r\n  const isFinal = node.is_final_authority\r\n  \r\n  return (\r\n    <div className={`\r\n      relative w-64 p-4 rounded-lg border-2 shadow-md transition-all hover:shadow-lg bg-white dark:bg-gray-800 group\r\n      ${isFinal ? 'border-yellow-500 dark:border-yellow-500 ring-2 ring-yellow-100 dark:ring-yellow-900/30' : 'border-gray-200 dark:border-gray-700'}\r\n    `}>\r\n      \r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-start mb-2\">\r\n        <h3 className=\"font-bold text-gray-900 dark:text-white text-sm leading-tight\">\r\n          {node.group_name}\r\n        </h3>\r\n        <button \r\n            onClick={onDelete}\r\n            className=\"text-gray-400 hover:text-red-600 transition-colors opacity-0 group-hover:opacity-100\"\r\n            title=\"Delete Group\"\r\n        >\r\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" /></svg>\r\n        </button>\r\n      </div>\r\n\r\n      {/* Stats */}\r\n      <div className=\"text-xs text-gray-500 dark:text-gray-400 flex gap-2\">\r\n        <span>Roles: {node.role_count || 0}</span>\r\n        {isFinal && <span className=\"text-yellow-600 font-semibold ml-auto\">Final Authority</span>}\r\n      </div>\r\n\r\n      {/* --- RIGHT BUTTON: Add Approver/Parent (ALWAYS VISIBLE) --- */}\r\n      <div className=\"absolute -right-4 top-1/2 -translate-y-1/2 z-20\">\r\n           <button \r\n             onClick={onAddParent}\r\n             className=\"flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full shadow-sm hover:bg-indigo-700 hover:scale-110 transition-all border-2 border-white dark:border-gray-800\"\r\n             title=\"Add Next Approver (Parent)\"\r\n           >\r\n             <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" /></svg>\r\n           </button>\r\n      </div>\r\n\r\n      {/* --- LEFT BUTTON: Add Subordinate/Child (ALWAYS VISIBLE) --- */}\r\n      <div className=\"absolute -left-4 top-1/2 -translate-y-1/2 z-20\">\r\n           <button \r\n             onClick={onAddSubordinate}\r\n             className=\"flex items-center justify-center w-8 h-8 bg-white dark:bg-gray-700 text-indigo-600 dark:text-indigo-300 rounded-full shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 hover:scale-110 transition-all border-2 border-indigo-200 dark:border-indigo-700\"\r\n             title=\"Add Feeder Group (Child)\"\r\n           >\r\n             <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" /></svg>\r\n           </button>\r\n      </div>\r\n\r\n    </div>\r\n  )\r\n}"],"names":[],"mappings":"AAAA,4CAA4C;;;;;;;AAW7B,SAAS,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,WAAW,EAAE,gBAAgB,EAAkB;IAEjG,MAAM,UAAU,KAAK,kBAAkB;IAEvC,qBACE,8OAAC;QAAI,WAAW,CAAC;;MAEf,EAAE,UAAU,4FAA4F,uCAAuC;IACjJ,CAAC;;0BAGC,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAG,WAAU;kCACX,KAAK,UAAU;;;;;;kCAElB,8OAAC;wBACG,SAAS;wBACT,WAAU;wBACV,OAAM;kCAEN,cAAA,8OAAC;4BAAI,WAAU;4BAAU,MAAK;4BAAO,QAAO;4BAAe,SAAQ;sCAAY,cAAA,8OAAC;gCAAK,eAAc;gCAAQ,gBAAe;gCAAQ,aAAa;gCAAG,GAAE;;;;;;;;;;;;;;;;;;;;;;0BAK1J,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;;4BAAK;4BAAQ,KAAK,UAAU,IAAI;;;;;;;oBAChC,yBAAW,8OAAC;wBAAK,WAAU;kCAAwC;;;;;;;;;;;;0BAItE,8OAAC;gBAAI,WAAU;0BACV,cAAA,8OAAC;oBACC,SAAS;oBACT,WAAU;oBACV,OAAM;8BAEN,cAAA,8OAAC;wBAAI,WAAU;wBAAU,MAAK;wBAAO,QAAO;wBAAe,SAAQ;kCAAY,cAAA,8OAAC;4BAAK,eAAc;4BAAQ,gBAAe;4BAAQ,aAAa;4BAAG,GAAE;;;;;;;;;;;;;;;;;;;;;0BAK3J,8OAAC;gBAAI,WAAU;0BACV,cAAA,8OAAC;oBACC,SAAS;oBACT,WAAU;oBACV,OAAM;8BAEN,cAAA,8OAAC;wBAAI,WAAU;wBAAU,MAAK;wBAAO,QAAO;wBAAe,SAAQ;kCAAY,cAAA,8OAAC;4BAAK,eAAc;4BAAQ,gBAAe;4BAAQ,aAAa;4BAAG,GAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMjK","debugId":null}},
    {"offset": {"line": 199, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IA8FsB,oBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 211, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/components/AddGroupModal.tsx"],"sourcesContent":["'use client'\r\nimport { useState } from 'react'\r\nimport { createGroupAction } from '../actions'\r\n\r\ninterface AddGroupModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  companyId: string\r\n  childGroupId: string | null // Updated to allow null\r\n  onSuccess: () => void\r\n}\r\n\r\nexport default function AddGroupModal({ isOpen, onClose, companyId, childGroupId, onSuccess }: AddGroupModalProps) {\r\n  const [name, setName] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const isGenesis = !childGroupId; // Check if this is the first group\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (!name.trim()) return\r\n    \r\n    setLoading(true)\r\n    const result = await createGroupAction(companyId, name, childGroupId)\r\n    setLoading(false)\r\n\r\n    if (result?.error) {\r\n      alert(result.error)\r\n    } else {\r\n      onSuccess()\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\">\r\n      <div className=\"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-96 border dark:border-gray-700\">\r\n        <h2 className=\"text-lg font-bold mb-4 text-gray-900 dark:text-white\">\r\n            {isGenesis ? 'Create First Group' : 'Insert Approval Step'}\r\n        </h2>\r\n        <p className=\"text-sm text-gray-500 mb-4\">\r\n          {isGenesis \r\n            ? \"This will be the first group in the chain. You can add parents or children to it later.\"\r\n            : \"This new group will approve reports coming from the selected group, and then forward them up the existing chain.\"\r\n          }\r\n        </p>\r\n        \r\n        <form onSubmit={handleSubmit}>\r\n          <div className=\"mb-4\">\r\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">Group Name</label>\r\n            <input \r\n              type=\"text\" \r\n              value={name} \r\n              onChange={e => setName(e.target.value)}\r\n              placeholder={isGenesis ? \"e.g. Squad Leaders\" : \"e.g. Platoon Sergeant\"}\r\n              className=\"w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white p-2\"\r\n              autoFocus\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex justify-end gap-2\">\r\n            <button type=\"button\" onClick={onClose} className=\"px-3 py-1.5 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded\">Cancel</button>\r\n            <button \r\n              type=\"submit\" \r\n              disabled={loading || !name.trim()}\r\n              className=\"px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50\"\r\n            >\r\n              {loading ? 'Saving...' : (isGenesis ? 'Create Group' : 'Create & Insert')}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}"],"names":[],"mappings":";;;;;AACA;AACA;AAFA;;;;AAYe,SAAS,cAAc,EAAE,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,YAAY,EAAE,SAAS,EAAsB;IAC/G,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAC;IACjC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IAEvC,MAAM,YAAY,CAAC,cAAc,mCAAmC;IAEpE,MAAM,eAAe,OAAO;QAC1B,EAAE,cAAc;QAChB,IAAI,CAAC,KAAK,IAAI,IAAI;QAElB,WAAW;QACX,MAAM,SAAS,MAAM,IAAA,mLAAiB,EAAC,WAAW,MAAM;QACxD,WAAW;QAEX,IAAI,QAAQ,OAAO;YACjB,MAAM,OAAO,KAAK;QACpB,OAAO;YACL;QACF;IACF;IAEA,IAAI,CAAC,QAAQ,OAAO;IAEpB,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAG,WAAU;8BACT,YAAY,uBAAuB;;;;;;8BAExC,8OAAC;oBAAE,WAAU;8BACV,YACG,4FACA;;;;;;8BAIN,8OAAC;oBAAK,UAAU;;sCACd,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;oCAAM,WAAU;8CAAkE;;;;;;8CACnF,8OAAC;oCACC,MAAK;oCACL,OAAO;oCACP,UAAU,CAAA,IAAK,QAAQ,EAAE,MAAM,CAAC,KAAK;oCACrC,aAAa,YAAY,uBAAuB;oCAChD,WAAU;oCACV,SAAS;;;;;;;;;;;;sCAIb,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;oCAAO,MAAK;oCAAS,SAAS;oCAAS,WAAU;8CAAwG;;;;;;8CAC1J,8OAAC;oCACC,MAAK;oCACL,UAAU,WAAW,CAAC,KAAK,IAAI;oCAC/B,WAAU;8CAET,UAAU,cAAe,YAAY,iBAAiB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOrE","debugId":null}},
    {"offset": {"line": 343, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IA8EsB,gBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 355, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IAmPsB,mBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 367, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\n// ACTION 1: Add a PARENT (Approver) to the selected group\r\n// Builds the chain UP (to the Right)\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove?: string | null \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (childGroupIdToApprove) {\r\n      // 1. Get Child's current parent\r\n      const { data: childGroup, error: fetchError } = await supabase\r\n        .from('approval_groups')\r\n        .select('next_approver_group_id')\r\n        .eq('id', childGroupIdToApprove)\r\n        .single();\r\n\r\n      if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n      const oldParentId = childGroup.next_approver_group_id;\r\n\r\n      // 2. Insert New Group\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: oldParentId,\r\n          is_final_authority: false\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n\r\n      // 3. Update Child\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ next_approver_group_id: newGroup.id })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  } \r\n  else {\r\n      // Genesis: Creating the first group in a company\r\n      const { error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: null,\r\n          is_final_authority: true\r\n        });\r\n\r\n      if (createError) return { error: createError.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// ACTION 2: Add a SUBORDINATE (Feeder) to the selected group\r\n// Builds the chain DOWN (to the Left)\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string,\r\n  parentGroupId: string\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // Simply insert a new group that points TO the parentGroupId\r\n  const { error } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: parentGroupId, // <--- Link it here\r\n      is_final_authority: false\r\n    });\r\n\r\n  if (error) return { error: error.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":";;;;;;;IA4NsB,mBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA","debugId":null}},
    {"offset": {"line": 379, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/components/RoleListModal.tsx"],"sourcesContent":["'use client'\r\nimport { useState, useEffect } from 'react'\r\nimport { getGroupRoles, deleteRoleAction, createRoleAction } from '../actions'\r\n\r\ninterface RoleListModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void // Reverted to simple close\r\n  onRoleUpdate: () => void // NEW: Call this to refresh parent data immediately\r\n  groupName: string\r\n  groupId: string\r\n  companyName: string\r\n  companyId: string\r\n}\r\n\r\ntype Role = { id: string; role_name: string; default_role_level: number }\r\n\r\nexport default function RoleListModal({ \r\n  isOpen, onClose, onRoleUpdate, groupName, groupId, companyName, companyId \r\n}: RoleListModalProps) {\r\n  \r\n  const [roles, setRoles] = useState<Role[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [isAdding, setIsAdding] = useState(false)\r\n\r\n  // Builder State\r\n  const [echelon, setEchelon] = useState('1st Platoon')\r\n  const [position, setPosition] = useState('Squad Member')\r\n  const [customLevel, setCustomLevel] = useState(10)\r\n\r\n  // Handle Escape Key\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') onClose()\r\n    }\r\n    if (isOpen) window.addEventListener('keydown', handleKeyDown)\r\n    return () => window.removeEventListener('keydown', handleKeyDown)\r\n  }, [isOpen, onClose])\r\n\r\n  // Fetch roles on open\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setLoading(true)\r\n      getGroupRoles(groupId).then(res => {\r\n        setRoles(res.roles)\r\n        setLoading(false)\r\n      })\r\n    }\r\n  }, [isOpen, groupId])\r\n\r\n  const previewName = `${companyName} ${echelon} ${position}`\r\n\r\n  const handleAdd = async () => {\r\n    setLoading(true)\r\n    const res = await createRoleAction(companyId, groupId, previewName, customLevel)\r\n    if (res.error) {\r\n      alert(res.error)\r\n    } else {\r\n      const updated = await getGroupRoles(groupId)\r\n      setRoles(updated.roles)\r\n      setIsAdding(false)\r\n      // --- TRIGGER PARENT REFRESH IMMEDIATELY ---\r\n      onRoleUpdate() \r\n    }\r\n    setLoading(false)\r\n  }\r\n\r\n  const handleDelete = async (roleId: string) => {\r\n    if(!confirm(\"Delete this role? Ensure no cadets are assigned to it first.\")) return\r\n    setLoading(true)\r\n    await deleteRoleAction(roleId)\r\n    const updated = await getGroupRoles(groupId)\r\n    setRoles(updated.roles)\r\n    // --- TRIGGER PARENT REFRESH IMMEDIATELY ---\r\n    onRoleUpdate()\r\n    setLoading(false)\r\n  }\r\n\r\n  // Auto-set level based on position\r\n  useEffect(() => {\r\n    const lowerPos = position.toLowerCase()\r\n    if (lowerPos.includes('commander')) setCustomLevel(40)\r\n    else if (lowerPos.includes('sergeant major') || lowerPos.includes('1sg')) setCustomLevel(38)\r\n    else if (lowerPos.includes('platoon leader')) setCustomLevel(30)\r\n    else if (lowerPos.includes('platoon sergeant')) setCustomLevel(28)\r\n    else if (lowerPos.includes('squad leader')) setCustomLevel(20)\r\n    else if (lowerPos.includes('laundry')) setCustomLevel(25)\r\n    else setCustomLevel(10)\r\n  }, [position])\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div \r\n      className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4\"\r\n      onClick={onClose} \r\n    >\r\n      <div \r\n        className=\"bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full border dark:border-gray-700 flex flex-col max-h-[85vh]\"\r\n        onClick={(e) => e.stopPropagation()}\r\n      >\r\n        {/* Header */}\r\n        <div className=\"p-6 border-b dark:border-gray-700 flex justify-between items-center\">\r\n          <div>\r\n            <h2 className=\"text-xl font-bold text-gray-900 dark:text-white\">{groupName}</h2>\r\n            <p className=\"text-sm text-gray-500\">Manage roles within this approval group.</p>\r\n          </div>\r\n          <button onClick={onClose} className=\"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200\"></button>\r\n        </div>\r\n\r\n        {/* Role List */}\r\n        <div className=\"flex-1 overflow-y-auto p-6 space-y-3\">\r\n          {loading && <div className=\"text-center text-gray-500 py-4\">Loading...</div>}\r\n          \r\n          {!loading && roles.length === 0 && (\r\n            <div className=\"text-center text-gray-500 py-8 italic\">No roles in this group yet.</div>\r\n          )}\r\n\r\n          {!loading && roles.map(role => (\r\n            <div key={role.id} className=\"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-md border dark:border-gray-700\">\r\n              <div>\r\n                <div className=\"font-medium text-gray-800 dark:text-gray-200\">{role.role_name}</div>\r\n                <div className=\"text-xs text-gray-500\">Level: {role.default_role_level}</div>\r\n              </div>\r\n              <button \r\n                onClick={() => handleDelete(role.id)}\r\n                className=\"text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded\"\r\n              >\r\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" /></svg>\r\n              </button>\r\n            </div>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Footer / Add Form */}\r\n        <div className=\"p-6 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 rounded-b-xl\">\r\n          {!isAdding ? (\r\n            <button \r\n              onClick={() => setIsAdding(true)}\r\n              className=\"w-full py-2 bg-indigo-600 text-white rounded-md font-medium hover:bg-indigo-700\"\r\n            >\r\n              + Add New Role\r\n            </button>\r\n          ) : (\r\n            <div className=\"space-y-4 animate-in fade-in slide-in-from-bottom-2\">\r\n              <h3 className=\"text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wide\">Role Builder</h3>\r\n              \r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label className=\"text-xs font-medium text-gray-500 mb-1 block\">Echelon</label>\r\n                  <select value={echelon} onChange={e => setEchelon(e.target.value)} className=\"w-full rounded text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white\">\r\n                    <option>Company</option>\r\n                    <option>1st Platoon</option>\r\n                    <option>2nd Platoon</option>\r\n                    <option>3rd Platoon</option>\r\n                    <option>Band</option>\r\n                  </select>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-xs font-medium text-gray-500 mb-1 block\">Position</label>\r\n                  <select value={position} onChange={e => setPosition(e.target.value)} className=\"w-full rounded text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white\">\r\n                    <option>Commander</option>\r\n                    <option>Executive Officer</option>\r\n                    <option>First Sergeant</option>\r\n                    <option>Platoon Leader</option>\r\n                    <option>Platoon Sergeant</option>\r\n                    <option>1st Squad Leader</option>\r\n                    <option>2nd Squad Leader</option>\r\n                    <option>3rd Squad Leader</option>                    \r\n                    <option>Laundry Sergeant</option>\r\n                    <option>Cadet</option>\r\n                  </select>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded border border-indigo-100 dark:border-indigo-800\">\r\n                <div className=\"text-xs text-indigo-600 dark:text-indigo-400 font-semibold mb-1\">Preview Name:</div>\r\n                <div className=\"text-sm font-mono text-gray-800 dark:text-gray-200\">{previewName}</div>\r\n              </div>\r\n\r\n              <div className=\"flex gap-3\">\r\n                <button onClick={() => setIsAdding(false)} className=\"flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700\">Cancel</button>\r\n                <button onClick={handleAdd} disabled={loading} className=\"flex-1 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700\">\r\n                  Create Role\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  )\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 870, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/components/ChainVisualizer.tsx"],"sourcesContent":["'use client'\r\n\r\nimport React, { useState, useEffect, useMemo, useRef, useCallback } from 'react'\r\nimport { getCompanyChain, deleteGroupAction, type ApprovalGroupNode } from '../actions'\r\nimport GroupNode from './GroupNode'\r\nimport AddGroupModal from './AddGroupModal'\r\nimport RoleListModal from './RoleListModal'\r\n\r\ninterface ChainVisualizerProps {\r\n  initialCompanies: { id: string; company_name: string }[]\r\n}\r\n\r\nconst getInitialCompanyId = (companies: ChainVisualizerProps['initialCompanies']) => {\r\n    const alphaCompany = companies.find(c => c.company_name === 'Alpha Company');\r\n    return alphaCompany?.id || companies[0]?.id || '';\r\n}\r\n\r\nexport default function ChainVisualizer({ initialCompanies }: ChainVisualizerProps) {\r\n    \r\n  const [selectedCompanyId, setSelectedCompanyId] = useState(() => getInitialCompanyId(initialCompanies));\r\n  \r\n  const [nodes, setNodes] = useState<ApprovalGroupNode[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const contentRef = useRef<HTMLDivElement>(null)\r\n  const [connections, setConnections] = useState<{ path: string; key: string }[]>([])\r\n  \r\n  const [isAddModalOpen, setIsAddModalOpen] = useState(false)\r\n  const [targetChildId, setTargetChildId] = useState<string | null>(null)\r\n  const [selectedNodeForRoles, setSelectedNodeForRoles] = useState<ApprovalGroupNode | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (!selectedCompanyId) {\r\n        setNodes([]);\r\n        setLoading(false);\r\n        return;\r\n    }\r\n    fetchChain();\r\n  }, [selectedCompanyId])\r\n\r\n  async function fetchChain() {\r\n    setLoading(true)\r\n    const data = await getCompanyChain(selectedCompanyId)\r\n    setNodes(data || [])\r\n    setLoading(false)\r\n  }\r\n\r\n  const columns = useMemo(() => {\r\n    if (nodes.length === 0) return []\r\n\r\n    const depthMap = new Map<string, number>()\r\n    const adjacency = new Map<string, string[]>() \r\n\r\n    nodes.forEach(node => {\r\n      const parent = node.next_approver_group_id || 'ROOT'\r\n      if (!adjacency.has(parent)) adjacency.set(parent, [])\r\n      adjacency.get(parent)?.push(node.id)\r\n    })\r\n\r\n    function assignDepth(nodeId: string, currentDepth: number) {\r\n      const children = adjacency.get(nodeId) || []\r\n      children.forEach(childId => {\r\n        depthMap.set(childId, currentDepth + 1)\r\n        assignDepth(childId, currentDepth + 1)\r\n      })\r\n    }\r\n\r\n    const finalNodes = nodes.filter(n => n.is_final_authority || !n.next_approver_group_id)\r\n    finalNodes.forEach(node => {\r\n      depthMap.set(node.id, 0)\r\n      assignDepth(node.id, 0)\r\n    })\r\n\r\n    nodes.forEach(node => {\r\n      if (!depthMap.has(node.id)) depthMap.set(node.id, 0) \r\n    })\r\n\r\n    const maxDepth = Math.max(...Array.from(depthMap.values()), 0)\r\n    const cols: ApprovalGroupNode[][] = Array.from({ length: maxDepth + 1 }, () => [])\r\n\r\n    nodes.forEach(node => {\r\n      const depth = depthMap.get(node.id)\r\n      if (depth !== undefined) cols[depth].push(node)\r\n    })\r\n\r\n    cols.forEach(col => col.sort((a, b) => a.group_name.localeCompare(b.group_name)))\r\n    return cols.reverse() \r\n  }, [nodes])\r\n\r\n  // --- UPDATED: Fix Ghost Arrows ---\r\n  const drawConnections = useCallback(() => {\r\n    if (!contentRef.current) return\r\n\r\n    // FIX: Explicitly clear connections if nodes are empty\r\n    if (nodes.length === 0) {\r\n        setConnections([])\r\n        return\r\n    }\r\n\r\n    const newConnections: { path: string; key: string }[] = []\r\n    const contentRect = contentRef.current.getBoundingClientRect()\r\n\r\n    nodes.forEach(node => {\r\n      if (!node.next_approver_group_id) return\r\n\r\n      const childEl = document.getElementById(`node-${node.id}`)\r\n      const parentEl = document.getElementById(`node-${node.next_approver_group_id}`)\r\n\r\n      if (childEl && parentEl) {\r\n        const childRect = childEl.getBoundingClientRect()\r\n        const parentRect = parentEl.getBoundingClientRect()\r\n\r\n        const startX = childRect.right - contentRect.left\r\n        const startY = (childRect.top + childRect.height / 2) - contentRect.top\r\n        \r\n        const endX = parentRect.left - contentRect.left\r\n        const endY = (parentRect.top + parentRect.height / 2) - contentRect.top\r\n\r\n        const path = `M ${startX} ${startY} L ${endX} ${endY}`\r\n        newConnections.push({ path, key: `${node.id}-${node.next_approver_group_id}` })\r\n      }\r\n    })\r\n\r\n    setConnections(newConnections)\r\n  }, [nodes])\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(drawConnections, 50)\r\n    window.addEventListener('resize', drawConnections)\r\n    return () => {\r\n      window.removeEventListener('resize', drawConnections)\r\n      clearTimeout(timer)\r\n    }\r\n  }, [drawConnections, columns])\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"Delete this group? Any groups pointing to it will be moved to its approver.\")) return\r\n    await deleteGroupAction(id)\r\n    fetchChain()\r\n  }\r\n  const handleOpenAdd = (childId: string) => {\r\n    setTargetChildId(childId)\r\n    setIsAddModalOpen(true)\r\n  }\r\n  const handleNodeClick = (node: ApprovalGroupNode) => {\r\n    setSelectedNodeForRoles(node)\r\n  }\r\n\r\n  const handleCreateFirst = () => {\r\n      setTargetChildId(null); \r\n      setIsAddModalOpen(true);\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Toolbar */}\r\n      <div className=\"flex flex-wrap items-center gap-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow z-10 relative\">\r\n        <label className=\"font-medium text-gray-700 dark:text-gray-300\">Select Company:</label>\r\n        <select \r\n          value={selectedCompanyId} \r\n          onChange={(e) => setSelectedCompanyId(e.target.value)}\r\n          className=\"rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white p-2\"\r\n        >\r\n          {initialCompanies.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}\r\n          {initialCompanies.length === 0 && <option value=\"\">No Companies Available</option>}\r\n        </select>\r\n        <button onClick={fetchChain} className=\"ml-auto text-sm text-indigo-600 hover:underline dark:text-indigo-400\">Refresh</button>\r\n      </div>\r\n\r\n      <div \r\n        className=\"overflow-x-auto bg-gray-50 dark:bg-gray-900/50 rounded-xl border dark:border-gray-700 flex flex-col\"\r\n        style={{ height: '700px' }}\r\n      >\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center h-full text-gray-500\">Loading Chain...</div>\r\n        ) : (\r\n          <div className=\"flex flex-col min-w-max h-full p-8 relative\">\r\n            \r\n            {/* HEADERS */}\r\n            {columns.length > 0 && (\r\n                <div className=\"flex gap-24 mb-4 border-b dark:border-gray-700 pb-2\">\r\n                {columns.map((_, colIndex) => (\r\n                    <div key={colIndex} className=\"w-64 text-center text-xs font-bold text-gray-400 uppercase tracking-wider\">\r\n                    {colIndex === columns.length - 1 ? \"Final Authority\" : `Step ${columns.length - 1 - colIndex}`}\r\n                    </div>\r\n                ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* NODES & LINES */}\r\n            <div ref={contentRef} className=\"relative flex-grow flex items-center\">\r\n              <svg className=\"absolute top-0 left-0 w-full h-full pointer-events-none z-0\">\r\n                <defs>\r\n                  <marker id=\"arrowhead\" markerWidth=\"10\" markerHeight=\"7\" refX=\"9\" refY=\"3.5\" orient=\"auto\">\r\n                    <polygon points=\"0 0, 10 3.5, 0 7\" fill=\"#9CA3AF\" />\r\n                  </marker>\r\n                </defs>\r\n                {connections.map(conn => (\r\n                  <path \r\n                    key={conn.key} \r\n                    d={conn.path} \r\n                    stroke=\"#9CA3AF\" \r\n                    strokeWidth=\"2\" \r\n                    fill=\"none\" \r\n                    markerEnd=\"url(#arrowhead)\"\r\n                    className=\"opacity-60 transition-all duration-300\"\r\n                  />\r\n                ))}\r\n              </svg>\r\n\r\n              <div className=\"flex gap-24 z-10 relative h-full w-full\">\r\n                {columns.map((col, colIndex) => (\r\n                  <div key={colIndex} className=\"flex flex-col gap-16 justify-center w-64\">\r\n                    {col.map(node => (\r\n                      <div key={node.id} id={`node-${node.id}`} onClick={() => handleNodeClick(node)} className=\"cursor-pointer\">\r\n                        <GroupNode \r\n                          node={node} \r\n                          onDelete={(e: React.MouseEvent) => { e.stopPropagation(); handleDelete(node.id); }}\r\n                          onAddParent={(e: React.MouseEvent) => { e.stopPropagation(); handleOpenAdd(node.id); }}\r\n                        />\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            {/* EMPTY STATE */}\r\n            {!loading && columns.length === 0 && (\r\n                 // UPDATED: Added z-20 to ensure it sits on top of the empty node container layer\r\n                 <div className=\"absolute inset-0 flex flex-col items-center justify-center text-gray-500 gap-4 z-20\">\r\n                    <p>{initialCompanies.length === 0 \r\n                        ? \"Configuration error: No companies were loaded from the server.\"\r\n                        : \"No approval groups found for this company.\"}</p>\r\n                    \r\n                    {initialCompanies.length > 0 && selectedCompanyId && (\r\n                        <button \r\n                            onClick={handleCreateFirst}\r\n                            className=\"px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 transition-colors\"\r\n                        >\r\n                            + Create First Group\r\n                        </button>\r\n                    )}\r\n                 </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {isAddModalOpen && (\r\n        <AddGroupModal \r\n          isOpen={isAddModalOpen}\r\n          onClose={() => setIsAddModalOpen(false)}\r\n          companyId={selectedCompanyId}\r\n          childGroupId={targetChildId}\r\n          onSuccess={() => {\r\n            setIsAddModalOpen(false)\r\n            fetchChain()\r\n          }}\r\n        />\r\n      )}\r\n\r\n      {selectedNodeForRoles && (\r\n        <RoleListModal\r\n          isOpen={!!selectedNodeForRoles}\r\n          onClose={() => setSelectedNodeForRoles(null)}\r\n          onRoleUpdate={fetchChain}\r\n          groupName={selectedNodeForRoles.group_name}\r\n          groupId={selectedNodeForRoles.id}\r\n          companyName={initialCompanies.find(c => c.id === selectedCompanyId)?.company_name || 'Unit'}\r\n          companyId={selectedCompanyId}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}
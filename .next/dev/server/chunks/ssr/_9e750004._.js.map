{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\n// Returns true if authorized, throws error if not.\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  // SECURITY POLICY: \r\n  // Only Staff (50+) or higher can configure the Chain of Command.\r\n  // You can adjust this to 40 if Company Commanders should edit their own structure.\r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING (Publicly viewable for transparency, or restrict if needed) ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  // 1. Fetch groups\r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  // 2. Flatten\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  // 3. Fetch external links (Final Authority nodes outside the company)\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  // View-only access is fine for logged in users\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n\r\n// --- MUTATIONS (Protected) ---\r\n\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string, \r\n  childGroupIdToApprove: string \r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // 1. Get Child's current parent\r\n  const { data: childGroup, error: fetchError } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', childGroupIdToApprove)\r\n    .single();\r\n\r\n  if (fetchError || !childGroup) return { error: \"Could not find the group you selected.\" };\r\n\r\n  const oldParentId = childGroup.next_approver_group_id;\r\n\r\n  // 2. Insert New Group\r\n  const { data: newGroup, error: createError } = await supabase\r\n    .from('approval_groups')\r\n    .insert({\r\n      group_name: groupName,\r\n      company_id: companyId,\r\n      next_approver_group_id: oldParentId,\r\n      is_final_authority: false\r\n    })\r\n    .select('id')\r\n    .single();\r\n\r\n  if (createError) return { error: createError.message };\r\n\r\n  // 3. Update Child\r\n  const { error: updateError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: newGroup.id })\r\n    .eq('id', childGroupIdToApprove);\r\n\r\n  if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  // 1. Check if group has roles inside it\r\n  // If we delete the group, the roles become orphans. Block this.\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  // 2. Get Target info\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  // 3. Re-link children (Heal the chain)\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ next_approver_group_id: parentId })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  // 4. Delete\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createRoleAction(\r\n  companyId: string,\r\n  groupId: string,\r\n  roleName: string,\r\n  defaultLevel: number\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase.from('roles').insert({\r\n    company_id: companyId,\r\n    approval_group_id: groupId,\r\n    role_name: roleName,\r\n    default_role_level: defaultLevel,\r\n    // Auto-set permissions based on level\r\n    can_manage_own_company_roster: defaultLevel >= 40, \r\n    can_manage_all_rosters: defaultLevel >= 50\r\n  })\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n  \r\n  // 1. CHECK FOR USAGE\r\n  // If a cadet is assigned to this role, we must block deletion or we break the roster.\r\n  const { count } = await supabase\r\n    .from('profiles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('role_id', roleId)\r\n\r\n  if (count && count > 0) {\r\n    return { error: `Cannot delete: ${count} cadet(s) are currently assigned to this role.` }\r\n  }\r\n  \r\n  // 2. Delete\r\n  const { error } = await supabase.from('roles').delete().eq('id', roleId)\r\n  \r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 232, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/.next-internal/server/app/manage/roles/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getCompanyChain as '40f822964e4558426439eaf89829b99701c5e902f5'} from 'ACTIONS_MODULE0'\nexport {deleteGroupAction as '4016bb68d9cf66d294d1ba16e7a69df06b10582128'} from 'ACTIONS_MODULE0'\nexport {createGroupAction as '70079b3c073a3793d07e63f99a88ba3a28fa1e70c4'} from 'ACTIONS_MODULE0'\nexport {getGroupRoles as '40d1742e2232c673b4b92bd7a1a01d3d91b6ef8390'} from 'ACTIONS_MODULE0'\nexport {deleteRoleAction as '40a5568cc820ffe2098c17cccc97ba4d2a6ccce129'} from 'ACTIONS_MODULE0'\nexport {createRoleAction as '78c1a20f4cc5bc2da7ea96c7a649be0cc1e65b0c41'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}
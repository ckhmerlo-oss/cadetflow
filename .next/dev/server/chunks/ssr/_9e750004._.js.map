{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/manage/roles/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\n\r\nexport type ApprovalGroupNode = {\r\n  id: string;\r\n  group_name: string;\r\n  next_approver_group_id: string | null;\r\n  company_id: string;\r\n  is_final_authority: boolean;\r\n  role_count?: number; \r\n}\r\n\r\n// --- SECURITY HELPER ---\r\nasync function requireAuth(supabase: SupabaseClient) {\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) throw new Error(\"Unauthorized\")\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id(default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  \r\n  if (roleLevel < 50) {\r\n    throw new Error(\"Insufficient permissions: You must be Staff to edit the Chain of Command.\")\r\n  }\r\n  \r\n  return user\r\n}\r\n\r\n// --- FETCHING ---\r\nexport async function getCompanyChain(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: companyGroups, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, group_name, next_approver_group_id, company_id, is_final_authority,\r\n      roles:roles(count)\r\n    `)\r\n    .eq('company_id', companyId)\r\n\r\n  if (error) {\r\n    console.error('Error fetching chain:', error)\r\n    return []\r\n  }\r\n\r\n  const formattedGroups = companyGroups.map(g => ({\r\n    ...g,\r\n    role_count: g.roles ? (g.roles as any)[0]?.count || 0 : 0\r\n  })) as ApprovalGroupNode[]\r\n\r\n  const outgoingLinkIds = formattedGroups\r\n    .map(g => g.next_approver_group_id)\r\n    .filter(id => id !== null) as string[];\r\n    \r\n  const existingIds = new Set(formattedGroups.map(g => g.id));\r\n  const missingIds = outgoingLinkIds.filter(id => !existingIds.has(id));\r\n\r\n  if (missingIds.length > 0) {\r\n    const { data: externalGroups } = await supabase\r\n      .from('approval_groups')\r\n      .select('id, group_name, next_approver_group_id, company_id, is_final_authority')\r\n      .in('id', missingIds);\r\n\r\n    if (externalGroups) {\r\n        formattedGroups.push(...(externalGroups as any[]));\r\n    }\r\n  }\r\n\r\n  return formattedGroups;\r\n}\r\n\r\nexport async function getGroupRoles(groupId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('approval_group_id', groupId)\r\n    .order('role_name')\r\n  \r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\nexport async function getAllApprovalGroups() {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e) { return [] }\r\n\r\n  const { data, error } = await supabase\r\n    .from('approval_groups')\r\n    .select(`\r\n      id, \r\n      group_name, \r\n      company:company_id (company_name)\r\n    `)\r\n    .order('group_name')\r\n  \r\n  if (error) return []\r\n  \r\n  return data.map((g: any) => ({\r\n    id: g.id,\r\n    label: `${g.group_name} (${g.company?.company_name || 'No Co.'})`\r\n  }))\r\n}\r\n\r\n\r\n// --- MUTATIONS ---\r\n\r\nexport async function createGroupAction(\r\n  companyId: string, \r\n  groupName: string | null, \r\n  childGroupIdToApprove?: string | null,\r\n  existingGroupId?: string | null\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  let targetParentId = existingGroupId;\r\n\r\n  if (!targetParentId) {\r\n      if (!groupName) return { error: \"Group Name is required for new groups.\" };\r\n\r\n      let nextLink = null;\r\n      \r\n      if (childGroupIdToApprove) {\r\n          const { data: child } = await supabase.from('approval_groups').select('next_approver_group_id').eq('id', childGroupIdToApprove).single();\r\n          nextLink = child?.next_approver_group_id || null;\r\n      }\r\n\r\n      const { data: newGroup, error: createError } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: nextLink,\r\n          is_final_authority: !nextLink\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (createError) return { error: createError.message };\r\n      targetParentId = newGroup.id;\r\n  }\r\n\r\n  if (childGroupIdToApprove && targetParentId) {\r\n      const { error: updateError } = await supabase\r\n        .from('approval_groups')\r\n        .update({ \r\n            next_approver_group_id: targetParentId,\r\n            is_final_authority: false\r\n        })\r\n        .eq('id', childGroupIdToApprove);\r\n\r\n      if (updateError) return { error: \"Failed to re-link the chain.\" };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function createSubordinateGroupAction(\r\n  companyId: string,\r\n  groupName: string | null,\r\n  parentGroupId: string,\r\n  existingGroupId?: string | null\r\n) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  if (existingGroupId) {\r\n      const { error } = await supabase\r\n        .from('approval_groups')\r\n        .update({ \r\n            next_approver_group_id: parentGroupId,\r\n            is_final_authority: false \r\n        })\r\n        .eq('id', existingGroupId);\r\n      \r\n      if (error) return { error: error.message };\r\n  } else {\r\n      if (!groupName) return { error: \"Name required.\" };\r\n      const { error } = await supabase\r\n        .from('approval_groups')\r\n        .insert({\r\n          group_name: groupName,\r\n          company_id: companyId,\r\n          next_approver_group_id: parentGroupId,\r\n          is_final_authority: false\r\n        });\r\n      if (error) return { error: error.message };\r\n  }\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteGroupAction(groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { count } = await supabase\r\n    .from('roles')\r\n    .select('*', { count: 'exact', head: true })\r\n    .eq('approval_group_id', groupId)\r\n  \r\n  if (count && count > 0) {\r\n    return { error: \"Cannot delete: This group still contains roles. Please move or delete them first.\" }\r\n  }\r\n\r\n  const { data: targetGroup } = await supabase\r\n    .from('approval_groups')\r\n    .select('next_approver_group_id')\r\n    .eq('id', groupId)\r\n    .single();\r\n  \r\n  if (!targetGroup) return { error: \"Group not found\" };\r\n  const parentId = targetGroup.next_approver_group_id;\r\n\r\n  const { error: relinkError } = await supabase\r\n    .from('approval_groups')\r\n    .update({ \r\n        next_approver_group_id: parentId,\r\n        is_final_authority: (parentId === null) \r\n    })\r\n    .eq('next_approver_group_id', groupId);\r\n\r\n  if (relinkError) return { error: \"Failed to re-link children groups.\" };\r\n\r\n  const { error: deleteError } = await supabase\r\n    .from('approval_groups')\r\n    .delete()\r\n    .eq('id', groupId);\r\n\r\n  if (deleteError) return { error: deleteError.message };\r\n\r\n  revalidatePath('/manage/roles');\r\n  return { success: true };\r\n}\r\n\r\n// --- NEW ROLE ASSIGNMENT ACTIONS ---\r\n\r\n// Action 1: Fetch Unassigned Roles for a Company\r\nexport async function getCompanyRoles(companyId: string) {\r\n  const supabase = createClient()\r\n  \r\n  // We want roles that are:\r\n  // 1. Belonging to this company\r\n  // 2. Not assigned to ANY approval group (approval_group_id IS NULL)\r\n  // OR roles that belong to this group (to show current) - but RoleListModal fetches current separately.\r\n  // So here we just want AVAILABLE roles.\r\n  \r\n  const { data, error } = await supabase\r\n    .from('roles')\r\n    .select('id, role_name, default_role_level')\r\n    .eq('company_id', companyId)\r\n    .is('approval_group_id', null)\r\n    .order('role_name')\r\n\r\n  return { roles: data || [], error: error?.message }\r\n}\r\n\r\n// Action 2: Link Role to Group\r\nexport async function assignRoleToGroupAction(roleId: string, groupId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase\r\n    .from('roles')\r\n    .update({ approval_group_id: groupId })\r\n    .eq('id', roleId)\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}\r\n\r\n// Action 3: Unlink Role from Group\r\nexport async function unassignRoleAction(roleId: string) {\r\n  const supabase = createClient()\r\n  try { await requireAuth(supabase) } catch (e: any) { return { error: e.message } }\r\n\r\n  const { error } = await supabase\r\n    .from('roles')\r\n    .update({ approval_group_id: null })\r\n    .eq('id', roleId)\r\n\r\n  if (error) return { error: error.message }\r\n  revalidatePath('/manage/roles')\r\n  return { success: true }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 290, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/.next-internal/server/app/manage/roles/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getCompanyChain as '40f822964e4558426439eaf89829b99701c5e902f5'} from 'ACTIONS_MODULE0'\nexport {deleteGroupAction as '4016bb68d9cf66d294d1ba16e7a69df06b10582128'} from 'ACTIONS_MODULE0'\nexport {createGroupAction as '78079b3c073a3793d07e63f99a88ba3a28fa1e70c4'} from 'ACTIONS_MODULE0'\nexport {createSubordinateGroupAction as '781b8c91e00c51cec97ea6f3ef449d49978b40516a'} from 'ACTIONS_MODULE0'\nexport {getAllApprovalGroups as '00ae9ae6ba58b134ae0dcbb1048b635e73b23ee2bd'} from 'ACTIONS_MODULE0'\nexport {getGroupRoles as '40d1742e2232c673b4b92bd7a1a01d3d91b6ef8390'} from 'ACTIONS_MODULE0'\nexport {getCompanyRoles as '40c44b7d62b9d33af21c6e0e829e12736ada41a06f'} from 'ACTIONS_MODULE0'\nexport {assignRoleToGroupAction as '608d78a921def9249bf4f244e6cff42c63651c6157'} from 'ACTIONS_MODULE0'\nexport {unassignRoleAction as '4043f145d74fb551c0f220d4655fa7d3b096b01be1'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/app/reports/history/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { EDIT_AUTHORIZED_ROLES, STAR_TOUR_AUTHORIZED_ROLES } from '../constants'\r\n\r\nexport async function updateCadetProfile(cadetId: string, formData: FormData) {\r\n  const supabase = createClient()\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: 'Unauthorized' }\r\n\r\n  const { data: editorProfile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id (role_name)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleName = (editorProfile?.role as any)?.role_name || ''\r\n  \r\n  const canEdit = EDIT_AUTHORIZED_ROLES.includes(roleName) || roleName.includes('TAC') || roleName === 'Admin';\r\n  if (!canEdit) return { error: 'You do not have permission to edit profiles.' }\r\n\r\n  const updates: { [key: string]: any } = {\r\n    cadet_rank: formData.get('cadet_rank')?.toString() || null,\r\n    room_number: formData.get('room_number')?.toString() || null,\r\n    grade_level: formData.get('grade_level')?.toString() || null,\r\n    years_attended: parseInt(formData.get('years_attended')?.toString() || '0'),\r\n    probation_status: formData.get('probation_status')?.toString() || null,\r\n    sport_fall: formData.get('sport_fall')?.toString() || null,\r\n    sport_winter: formData.get('sport_winter')?.toString() || null,\r\n    sport_spring: formData.get('sport_spring')?.toString() || null,\r\n  }\r\n\r\n  const canManageStarTours = STAR_TOUR_AUTHORIZED_ROLES.includes(roleName);\r\n  if (canManageStarTours) {\r\n    updates.has_star_tours = formData.get('has_star_tours') === 'on'\r\n  }\r\n\r\n  const { error } = await supabase.from('profiles').update(updates).eq('id', cadetId)\r\n\r\n  if (error) {\r\n    console.error('Profile update error:', error.message)\r\n    return { error: `Update failed: ${error.message}` }\r\n  }\r\n\r\n  revalidatePath(`/profile/${cadetId}`)\r\n  revalidatePath(`/reports/daily`)\r\n  return { success: true }\r\n}\r\n\r\n// --- NEW FUNCTION FOR TOUR ADJUSTMENT ---\r\nexport async function submitTourAdjustment(cadetId: string, amount: number, reason: string) {\r\n  const supabase = createClient()\r\n  \r\n  // 1. Auth Check\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  if (!user) return { error: 'Unauthorized' }\r\n\r\n  // 2. Permission Check (Commandant Staff / Level 90+)\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role:role_id (default_role_level)')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const roleLevel = (profile?.role as any)?.default_role_level || 0\r\n  if (roleLevel < 90) {\r\n    return { error: 'Permission Denied: Only Commandant Staff can manually adjust tour balances.' }\r\n  }\r\n\r\n  if (amount === 0) return { error: 'Adjustment amount cannot be zero.' }\r\n  if (!reason) return { error: 'A reason is required for adjustments.' }\r\n\r\n  // 3. Insert Ledger Entry\r\n  const { error } = await supabase.from('tour_ledger').insert({\r\n    cadet_id: cadetId,\r\n    staff_id: user.id,\r\n    amount: amount,\r\n    action: 'adjustment', // This matches the SQL update\r\n    comment: reason\r\n  })\r\n\r\n  if (error) {\r\n    console.error('Adjustment Error:', error)\r\n    return { error: error.message }\r\n  }\r\n\r\n  // 4. Revalidate\r\n  revalidatePath(`/profile/${cadetId}`)\r\n  revalidatePath(`/ledger/${cadetId}`)\r\n  \r\n  return { success: true }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ckhme/my-workflow-app/.next-internal/server/app/reports/history/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {updateCadetProfile as '6000136b8ece2ce1ce2713295d417bd84ff301b559'} from 'ACTIONS_MODULE0'\nexport {submitTourAdjustment as '70ea2507aa001bfaeaa3fbe3d11e1087d42e91d956'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}